---
title: "Data Analysis"
format: html
---
The project aims at an in-depth analysis of Labor Condition Application (LCA) datasets covering U.S. work visas for the years 2019 to 2024. The primary datasets that contain the disclosures consist of 90+ variables for each case including but not limited to the employer, the occupation, the location and the wage. As far as visualization is concerned, we will particularly deal with the statuses of the cases over the course of time, thus getting the CASE_STATUS attribute from every quarterly file (Q1-Q4) and attributing each record with the respective year. The detailed statuses will then be collapsed into broader categories thus treating “Certified” and “Certified – Withdrawn” as the accepted cases and “Denied” and “Withdrawn” as the rejected ones, in order to find out how the approval and denial patterns have shifted over the years. 


```{r}
# Load required libraries
library(readxl)
library(dplyr)
library(ggplot2)

options(warn = -1)

# Helper function to read only CASE_STATUS column
read_status_only <- function(file_path, year) {
  df <- read_excel(file_path, col_types = "text")
  # Keep only CASE_STATUS column and add YEAR
  df <- df %>% 
    select(CASE_STATUS) %>%
    mutate(YEAR = year)
  return(df)
}

# Read 2019 data
cat("Loading 2019 data...\n")
df_2019 <- read_status_only("data/2019/FY2019.xlsx", 2019)

# Read 2020 data
cat("Loading 2020 data...\n")
df_2020_q1 <- read_status_only("data/2020/FY2020_Q1.xlsx", 2020)
df_2020_q2 <- read_status_only("data/2020/FY2020_Q2.xlsx", 2020)
df_2020_q3 <- read_status_only("data/2020/FY2020_Q3.xlsx", 2020)
df_2020_q4 <- read_status_only("data/2020/FY2020_Q4.xlsx", 2020)
df_2020 <- bind_rows(df_2020_q1, df_2020_q2, df_2020_q3, df_2020_q4)
rm(df_2020_q1, df_2020_q2, df_2020_q3, df_2020_q4)
gc()

# Read 2021 data
cat("Loading 2021 data...\n")
df_2021_q1 <- read_status_only("data/2021/FY2021_Q1.xlsx", 2021)
df_2021_q2 <- read_status_only("data/2021/FY2021_Q2.xlsx", 2021)
df_2021_q3 <- read_status_only("data/2021/FY2021_Q3.xlsx", 2021)
df_2021_q4 <- read_status_only("data/2021/FY2021_Q4.xlsx", 2021)
df_2021 <- bind_rows(df_2021_q1, df_2021_q2, df_2021_q3, df_2021_q4)
rm(df_2021_q1, df_2021_q2, df_2021_q3, df_2021_q4)
gc()

# Read 2022 data
cat("Loading 2022 data...\n")
df_2022_q1 <- read_status_only("data/2022/FY2022_Q1.xlsx", 2022)
df_2022_q2 <- read_status_only("data/2022/FY2022_Q2.xlsx", 2022)
df_2022_q3 <- read_status_only("data/2022/FY2022_Q3.xlsx", 2022)
df_2022_q4 <- read_status_only("data/2022/FY2022_Q4.xlsx", 2022)
df_2022 <- bind_rows(df_2022_q1, df_2022_q2, df_2022_q3, df_2022_q4)
rm(df_2022_q1, df_2022_q2, df_2022_q3, df_2022_q4)
gc()

# Read 2023 data
cat("Loading 2023 data...\n")
df_2023_q1 <- read_status_only("data/2023/FY2023_Q1.xlsx", 2023)
df_2023_q2 <- read_status_only("data/2023/FY2023_Q2.xlsx", 2023)
df_2023_q3 <- read_status_only("data/2023/FY2023_Q3.xlsx", 2023)
df_2023_q4 <- read_status_only("data/2023/FY2023_Q4.xlsx", 2023)
df_2023 <- bind_rows(df_2023_q1, df_2023_q2, df_2023_q3, df_2023_q4)
rm(df_2023_q1, df_2023_q2, df_2023_q3, df_2023_q4)
gc()

# Read 2024 data
cat("Loading 2024 data...\n")
df_2024_q1 <- read_status_only("data/2024/FY2024_Q1.xlsx", 2024)
df_2024_q2 <- read_status_only("data/2024/FY2024_Q2.xlsx", 2024)
df_2024_q3 <- read_status_only("data/2024/FY2024_Q3.xlsx", 2024)
df_2024_q4 <- read_status_only("data/2024/FY2024_Q4.xlsx", 2024)
df_2024 <- bind_rows(df_2024_q1, df_2024_q2, df_2024_q3, df_2024_q4)
rm(df_2024_q1, df_2024_q2, df_2024_q3, df_2024_q4)
gc()


# Combine all years
cat("Combining all years...\n")
all_data <- bind_rows(df_2019, df_2020, df_2021, df_2022, df_2023, df_2024)

# Clear individual year dataframes
rm(df_2019, df_2020, df_2021, df_2022, df_2023, df_2024)
gc()

# Check the data
cat("\nTotal records loaded:", nrow(all_data), "\n")
cat("Unique case statuses:", unique(all_data$CASE_STATUS), "\n")

# Categorize case status into Accepted/Rejected
all_data <- all_data %>%
  mutate(STATUS_CATEGORY = case_when(
    CASE_STATUS %in% c("Certified", "Certified - Withdrawn") ~ "Accepted",
    CASE_STATUS %in% c("Denied", "Withdrawn") ~ "Rejected",
    TRUE ~ "Other"
  ))

# Create summary by year and status
summary_data <- all_data %>%
  filter(STATUS_CATEGORY %in% c("Accepted", "Rejected")) %>%
  group_by(YEAR, STATUS_CATEGORY) %>%
  summarise(COUNT = n(), .groups = "drop")

```

```{r}
# Categorize case status into Accepted/Rejected
all_data <- all_data %>%
  mutate(STATUS_CATEGORY = case_when(
    CASE_STATUS %in% c("Certified", "Certified - Withdrawn", "CERTIFIED", "CERTIFIED-WITHDRAWN") ~ "Accepted",
    CASE_STATUS %in% c("Denied", "Withdrawn", "DENIED", "WITHDRAWN") ~ "Rejected",
    TRUE ~ "Other"
  ))

# Create summary by year and status
summary_data <- all_data %>%
  filter(STATUS_CATEGORY %in% c("Accepted", "Rejected")) %>%
  group_by(YEAR, STATUS_CATEGORY) %>%
  summarise(COUNT = n(), .groups = "drop")
# Print summary
print(all_data)
print(summary_data)

# Create frequency histogram
ggplot(summary_data, aes(x = factor(YEAR), y = COUNT, fill = STATUS_CATEGORY)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_text(aes(label = scales::comma(COUNT)), 
            position = position_dodge(width = 0.7), 
            vjust = -0.5, 
            size = 3.5) +
  scale_fill_manual(values = c("Accepted" = "#2ecc71", "Rejected" = "#e74c3c"),
                    name = "Status") +
  scale_y_continuous(labels = scales::comma, 
                     expand = expansion(mult = c(0, 0.1))) +
  labs(title = "H-1B Visa Filing Status by Year",
       subtitle = "Frequency of Accepted vs Rejected Applications (FY 2019-2024)",
       x = "Fiscal Year",
       y = "Number of Applications",
       caption = "Data Source: H-1B Disclosure Data") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray40"),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )

# Create additional percentage view
summary_data_pct <- summary_data %>%
  group_by(YEAR) %>%
  mutate(PERCENTAGE = COUNT / sum(COUNT) * 100)

# Print acceptance rates by year
acceptance_rates <- summary_data_pct %>%
  filter(STATUS_CATEGORY == "Accepted") %>%
  select(YEAR, PERCENTAGE) %>%
  mutate(PERCENTAGE = round(PERCENTAGE, 2))

cat("\nAcceptance Rates by Year:\n")
print(acceptance_rates)

# Create stacked percentage bar chart
ggplot(summary_data_pct, aes(x = factor(YEAR), y = PERCENTAGE, fill = STATUS_CATEGORY)) +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = paste0(round(PERCENTAGE, 1), "%")), 
            position = position_stack(vjust = 0.5), 
            size = 4, 
            color = "white",
            fontface = "bold") +
  scale_fill_manual(values = c("Accepted" = "#2ecc71", "Rejected" = "#e74c3c"),
                    name = "Status") +
  labs(title = "H-1B Visa Acceptance Rate by Year",
       subtitle = "Percentage Distribution (FY 2019-2024)",
       x = "Fiscal Year",
       y = "Percentage (%)",
       caption = "Data Source: H-1B Disclosure Data") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray40"),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )

```

The analysis showed relatively stable volumes in most years, with accepted applications typically in the 550,000–650,000 range and rejected applications forming only a small fraction of the total. A notable aspect of the data is a prominent spike in accepted filings in FY 2021, where the count rises to more than 800,000 cases. This feature aligns with two well-documented contextual factors which are a rebound in employer demand following the initial COVID-19 hiring slowdown in 2020, and the introduction of the electronic H-1B registration system for the FY 2021 cap season, which reduced initial filing costs and made it easier for employers to submit registrations. 




```{r}
library(tidyr)


lca <- read_excel("data/2024/FY2024_Q4.xlsx")

cols_to_check <- c(
  "CASE_STATUS", "RECEIVED_DATE", "VISA_CLASS", "FULL_TIME_POSITION",
  "TOTAL_WORKER_POSITIONS", "JOB_TITLE",
  "SOC_CODE", "SOC_TITLE",
  "EMPLOYER_NAME", "EMPLOYER_STATE", "EMPLOYER_CITY",
  "NAICS_CODE",
  "WORKSITE_CITY", "WORKSITE_STATE",
  "WAGE_RATE_OF_PAY_FROM", "WAGE_RATE_OF_PAY_TO", "WAGE_UNIT_OF_PAY",
  "PREVAILING_WAGE", "PW_UNIT_OF_PAY", "PW_WAGE_LEVEL"
)

missing_summary <- lca |>
  select(all_of(cols_to_check)) |>
  summarise(across(everything(), ~ mean(is.na(.)))) |>
  pivot_longer(everything(),
               names_to = "variable",
               values_to = "prop_missing")

ggplot(missing_summary,
       aes(x = reorder(variable, prop_missing),
           y = prop_missing)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Variable",
    y = "Percent missing",
    title = "Missingness by variable (key columns)"
  )


```


The plot visualising missing data for FY2024 Q4 shows that almost all of our key variables have no missing data for fields such as CASE_STATUS, employer and worksite location, SOC codes/titles, and most wage‐related variables. The main exceptions are WAGE_RATE_OF_PAY_TO, which has a noticable proportion of missing values, and PW_WAGE_LEVEL, which has a smaller but still significant amount of missingness. Because WAGE_RATE_OF_PAY_TO is often blank when a single wage value is reported, we focus primarily on WAGE_RATE_OF_PAY_FROM for our wage analyses.
