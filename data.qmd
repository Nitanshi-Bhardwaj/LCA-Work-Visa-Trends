#Data

```{r}
# Load required libraries
library(readxl)
library(dplyr)
library(ggplot2)

options(warn = -1)

# Helper function to read only CASE_STATUS column
read_status_only <- function(file_path, year) {
  df <- read_excel(file_path, col_types = "text")
  # Keep only CASE_STATUS column and add YEAR
  df <- df %>% 
    select(CASE_STATUS) %>%
    mutate(YEAR = year)
  return(df)
}

# Read 2019 data
cat("Loading 2019 data...\n")
df_2019 <- read_status_only("data/2019/FY2019.xlsx", 2019)

# Read 2020 data
cat("Loading 2020 data...\n")
df_2020_q1 <- read_status_only("data/2020/FY2020_Q1.xlsx", 2020)
df_2020_q2 <- read_status_only("data/2020/FY2020_Q2.xlsx", 2020)
df_2020_q3 <- read_status_only("data/2020/FY2020_Q3.xlsx", 2020)
df_2020_q4 <- read_status_only("data/2020/FY2020_Q4.xlsx", 2020)
df_2020 <- bind_rows(df_2020_q1, df_2020_q2, df_2020_q3, df_2020_q4)
rm(df_2020_q1, df_2020_q2, df_2020_q3, df_2020_q4)
gc()

# Read 2021 data
cat("Loading 2021 data...\n")
df_2021_q1 <- read_status_only("data/2021/FY2021_Q1.xlsx", 2021)
df_2021_q2 <- read_status_only("data/2021/FY2021_Q2.xlsx", 2021)
df_2021_q3 <- read_status_only("data/2021/FY2021_Q3.xlsx", 2021)
df_2021_q4 <- read_status_only("data/2021/FY2021_Q4.xlsx", 2021)
df_2021 <- bind_rows(df_2021_q1, df_2021_q2, df_2021_q3, df_2021_q4)
rm(df_2021_q1, df_2021_q2, df_2021_q3, df_2021_q4)
gc()

# Read 2022 data
cat("Loading 2022 data...\n")
df_2022_q1 <- read_status_only("data/2022/FY2022_Q1.xlsx", 2022)
df_2022_q2 <- read_status_only("data/2022/FY2022_Q2.xlsx", 2022)
df_2022_q3 <- read_status_only("data/2022/FY2022_Q3.xlsx", 2022)
df_2022_q4 <- read_status_only("data/2022/FY2022_Q4.xlsx", 2022)
df_2022 <- bind_rows(df_2022_q1, df_2022_q2, df_2022_q3, df_2022_q4)
rm(df_2022_q1, df_2022_q2, df_2022_q3, df_2022_q4)
gc()

# Read 2023 data
cat("Loading 2023 data...\n")
df_2023_q1 <- read_status_only("data/2023/FY2023_Q1.xlsx", 2023)
df_2023_q2 <- read_status_only("data/2023/FY2023_Q2.xlsx", 2023)
df_2023_q3 <- read_status_only("data/2023/FY2023_Q3.xlsx", 2023)
df_2023_q4 <- read_status_only("data/2023/FY2023_Q4.xlsx", 2023)
df_2023 <- bind_rows(df_2023_q1, df_2023_q2, df_2023_q3, df_2023_q4)
rm(df_2023_q1, df_2023_q2, df_2023_q3, df_2023_q4)
gc()

# Read 2024 data
cat("Loading 2024 data...\n")
df_2024_q1 <- read_status_only("data/2024/FY2024_Q1.xlsx", 2024)
df_2024_q2 <- read_status_only("data/2024/FY2024_Q2.xlsx", 2024)
df_2024_q3 <- read_status_only("data/2024/FY2024_Q3.xlsx", 2024)
df_2024_q4 <- read_status_only("data/2024/FY2024_Q4.xlsx", 2024)
df_2024 <- bind_rows(df_2024_q1, df_2024_q2, df_2024_q3, df_2024_q4)
rm(df_2024_q1, df_2024_q2, df_2024_q3, df_2024_q4)
gc()


# Combine all years
cat("Combining all years...\n")
all_data <- bind_rows(df_2019, df_2020, df_2021, df_2022, df_2023, df_2024)

# Clear individual year dataframes
rm(df_2019, df_2020, df_2021, df_2022, df_2023, df_2024)
gc()

# Check the data
cat("\nTotal records loaded:", nrow(all_data), "\n")
cat("Unique case statuses:", unique(all_data$CASE_STATUS), "\n")

# Categorize case status into Accepted/Rejected
all_data <- all_data %>%
  mutate(STATUS_CATEGORY = case_when(
    CASE_STATUS %in% c("Certified", "Certified - Withdrawn") ~ "Accepted",
    CASE_STATUS %in% c("Denied", "Withdrawn") ~ "Rejected",
    TRUE ~ "Other"
  ))

# Create summary by year and status
summary_data <- all_data %>%
  filter(STATUS_CATEGORY %in% c("Accepted", "Rejected")) %>%
  group_by(YEAR, STATUS_CATEGORY) %>%
  summarise(COUNT = n(), .groups = "drop")

```
```


```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)

lca <- read_excel("data/2024/FY2024_Q4.xlsx")

cols_to_check <- c(
  "CASE_STATUS", "RECEIVED_DATE", "VISA_CLASS", "FULL_TIME_POSITION",
  "TOTAL_WORKER_POSITIONS", "JOB_TITLE",
  "SOC_CODE", "SOC_TITLE",
  "EMPLOYER_NAME", "EMPLOYER_STATE", "EMPLOYER_CITY",
  "NAICS_CODE",
  "WORKSITE_CITY", "WORKSITE_STATE",
  "WAGE_RATE_OF_PAY_FROM", "WAGE_RATE_OF_PAY_TO", "WAGE_UNIT_OF_PAY",
  "PREVAILING_WAGE", "PW_UNIT_OF_PAY", "PW_WAGE_LEVEL"
)

missing_summary <- lca |>
  select(all_of(cols_to_check)) |>
  summarise(across(everything(), ~ mean(is.na(.)))) |>
  pivot_longer(everything(),
               names_to = "variable",
               values_to = "prop_missing")

ggplot(missing_summary,
       aes(x = reorder(variable, prop_missing),
           y = prop_missing)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Variable",
    y = "Percent missing",
    title = "Missingness by variable (key columns)"
  )


```
