---
title: "start"
format: html
---

```{r}
# Load required libraries
library(readxl)
library(dplyr)
library(ggplot2)

options(warn = -1)

# Helper function to read only CASE_STATUS column
read_status_only <- function(file_path, year) {
  df <- read_excel(file_path, col_types = "text")
  # Keep only CASE_STATUS column and add YEAR
  df <- df %>% 
    select(CASE_STATUS) %>%
    mutate(YEAR = year)
  return(df)
}

# Read 2019 data
cat("Loading 2019 data...\n")
df_2019 <- read_status_only("data/2019/FY2019.xlsx", 2019)

# Read 2020 data
cat("Loading 2020 data...\n")
df_2020_q1 <- read_status_only("data/2020/FY2020_Q1.xlsx", 2020)
df_2020_q2 <- read_status_only("data/2020/FY2020_Q2.xlsx", 2020)
df_2020_q3 <- read_status_only("data/2020/FY2020_Q3.xlsx", 2020)
df_2020_q4 <- read_status_only("data/2020/FY2020_Q4.xlsx", 2020)
df_2020 <- bind_rows(df_2020_q1, df_2020_q2, df_2020_q3, df_2020_q4)
rm(df_2020_q1, df_2020_q2, df_2020_q3, df_2020_q4)
gc()

# Read 2021 data
cat("Loading 2021 data...\n")
df_2021_q1 <- read_status_only("data/2021/FY2021_Q1.xlsx", 2021)
df_2021_q2 <- read_status_only("data/2021/FY2021_Q2.xlsx", 2021)
df_2021_q3 <- read_status_only("data/2021/FY2021_Q3.xlsx", 2021)
df_2021_q4 <- read_status_only("data/2021/FY2021_Q4.xlsx", 2021)
df_2021 <- bind_rows(df_2021_q1, df_2021_q2, df_2021_q3, df_2021_q4)
rm(df_2021_q1, df_2021_q2, df_2021_q3, df_2021_q4)
gc()

# Read 2022 data
cat("Loading 2022 data...\n")
df_2022_q1 <- read_status_only("data/2022/FY2022_Q1.xlsx", 2022)
df_2022_q2 <- read_status_only("data/2022/FY2022_Q2.xlsx", 2022)
df_2022_q3 <- read_status_only("data/2022/FY2022_Q3.xlsx", 2022)
df_2022_q4 <- read_status_only("data/2022/FY2022_Q4.xlsx", 2022)
df_2022 <- bind_rows(df_2022_q1, df_2022_q2, df_2022_q3, df_2022_q4)
rm(df_2022_q1, df_2022_q2, df_2022_q3, df_2022_q4)
gc()

# Read 2023 data
cat("Loading 2023 data...\n")
df_2023_q1 <- read_status_only("data/2023/FY2023_Q1.xlsx", 2023)
df_2023_q2 <- read_status_only("data/2023/FY2023_Q2.xlsx", 2023)
df_2023_q3 <- read_status_only("data/2023/FY2023_Q3.xlsx", 2023)
df_2023_q4 <- read_status_only("data/2023/FY2023_Q4.xlsx", 2023)
df_2023 <- bind_rows(df_2023_q1, df_2023_q2, df_2023_q3, df_2023_q4)
rm(df_2023_q1, df_2023_q2, df_2023_q3, df_2023_q4)
gc()

# Read 2024 data
cat("Loading 2024 data...\n")
df_2024_q1 <- read_status_only("data/2024/FY2024_Q1.xlsx", 2024)
df_2024_q2 <- read_status_only("data/2024/FY2024_Q2.xlsx", 2024)
df_2024_q3 <- read_status_only("data/2024/FY2024_Q3.xlsx", 2024)
df_2024_q4 <- read_status_only("data/2024/FY2024_Q4.xlsx", 2024)
df_2024 <- bind_rows(df_2024_q1, df_2024_q2, df_2024_q3, df_2024_q4)
rm(df_2024_q1, df_2024_q2, df_2024_q3, df_2024_q4)
gc()


# Combine all years
cat("Combining all years...\n")
all_data <- bind_rows(df_2019, df_2020, df_2021, df_2022, df_2023, df_2024)

# Clear individual year dataframes
rm(df_2019, df_2020, df_2021, df_2022, df_2023, df_2024)
gc()

# Check the data
cat("\nTotal records loaded:", nrow(all_data), "\n")
cat("Unique case statuses:", unique(all_data$CASE_STATUS), "\n")

# Categorize case status into Accepted/Rejected
all_data <- all_data %>%
  mutate(STATUS_CATEGORY = case_when(
    CASE_STATUS %in% c("Certified", "Certified - Withdrawn") ~ "Accepted",
    CASE_STATUS %in% c("Denied", "Withdrawn") ~ "Rejected",
    TRUE ~ "Other"
  ))

# Create summary by year and status
summary_data <- all_data %>%
  filter(STATUS_CATEGORY %in% c("Accepted", "Rejected")) %>%
  group_by(YEAR, STATUS_CATEGORY) %>%
  summarise(COUNT = n(), .groups = "drop")

```

```{r}
# Categorize case status into Accepted/Rejected
all_data <- all_data %>%
  mutate(STATUS_CATEGORY = case_when(
    CASE_STATUS %in% c("Certified", "Certified - Withdrawn", "CERTIFIED", "CERTIFIED-WITHDRAWN") ~ "Accepted",
    CASE_STATUS %in% c("Denied", "Withdrawn", "DENIED", "WITHDRAWN") ~ "Rejected",
    TRUE ~ "Other"
  ))

# Create summary by year and status
summary_data <- all_data %>%
  filter(STATUS_CATEGORY %in% c("Accepted", "Rejected")) %>%
  group_by(YEAR, STATUS_CATEGORY) %>%
  summarise(COUNT = n(), .groups = "drop")
# Print summary
print(all_data)
print(summary_data)

# Create frequency histogram
ggplot(summary_data, aes(x = factor(YEAR), y = COUNT, fill = STATUS_CATEGORY)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_text(aes(label = scales::comma(COUNT)), 
            position = position_dodge(width = 0.7), 
            vjust = -0.5, 
            size = 3.5) +
  scale_fill_manual(values = c("Accepted" = "#2ecc71", "Rejected" = "#e74c3c"),
                    name = "Status") +
  scale_y_continuous(labels = scales::comma, 
                     expand = expansion(mult = c(0, 0.1))) +
  labs(title = "H-1B Visa Filing Status by Year",
       subtitle = "Frequency of Accepted vs Rejected Applications (FY 2019-2024)",
       x = "Fiscal Year",
       y = "Number of Applications",
       caption = "Data Source: H-1B Disclosure Data") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray40"),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )

# Optional: Save the plot
#ggsave("h1b_visa_status_histogram.png", width = 12, height = 7, dpi = 300)

# Create additional percentage view
summary_data_pct <- summary_data %>%
  group_by(YEAR) %>%
  mutate(PERCENTAGE = COUNT / sum(COUNT) * 100)

# Print acceptance rates by year
acceptance_rates <- summary_data_pct %>%
  filter(STATUS_CATEGORY == "Accepted") %>%
  select(YEAR, PERCENTAGE) %>%
  mutate(PERCENTAGE = round(PERCENTAGE, 2))

cat("\nAcceptance Rates by Year:\n")
print(acceptance_rates)

# Create stacked percentage bar chart
ggplot(summary_data_pct, aes(x = factor(YEAR), y = PERCENTAGE, fill = STATUS_CATEGORY)) +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = paste0(round(PERCENTAGE, 1), "%")), 
            position = position_stack(vjust = 0.5), 
            size = 4, 
            color = "white",
            fontface = "bold") +
  scale_fill_manual(values = c("Accepted" = "#2ecc71", "Rejected" = "#e74c3c"),
                    name = "Status") +
  labs(title = "H-1B Visa Acceptance Rate by Year",
       subtitle = "Percentage Distribution (FY 2019-2024)",
       x = "Fiscal Year",
       y = "Percentage (%)",
       caption = "Data Source: H-1B Disclosure Data") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray40"),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )

# Save percentage plot
# ggsave("h1b_visa_acceptance_rate.png", width = 12, height = 7, dpi = 300)

```
